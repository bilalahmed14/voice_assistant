<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Cloning</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .recording-status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .recording {
            background-color: #ffebee;
            color: #c62828;
        }
        .not-recording {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        .audio-player {
            margin: 20px 0;
        }
        .provider-select {
            margin-bottom: 20px;
        }
        .sample-text {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border: 1px solid #dee2e6;
        }
        .sample-text p {
            margin-bottom: 0;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Voice Cloning</h1>
        
        <!-- Provider Selection -->
        <div class="provider-select">
            <h5>Select TTS Provider:</h5>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="ttsProvider" id="openaiProvider" value="openai" checked>
                <label class="form-check-label" for="openaiProvider">
                    OpenAI
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="ttsProvider" id="elevenlabsProvider" value="elevenlabs">
                <label class="form-check-label" for="elevenlabsProvider">
                    ElevenLabs
                </label>
            </div>
        </div>

        <!-- Record Voice Sample -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Step 1: Record Voice Sample</h5>
                <p class="card-text">Please read the following text to create your voice sample:</p>
                
                <div class="sample-text">
                    <p>"The quick brown fox jumps over the lazy dog. This pangram contains every letter of the English alphabet at least once. It's commonly used to test typing speed and display fonts. The sentence is short but includes a variety of sounds and phonemes, making it ideal for voice analysis."</p>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> Tips for best results:
                    <ul class="mb-0">
                        <li>Read the text clearly and at a natural pace</li>
                        <li>Speak in a quiet environment</li>
                        <li>Keep a consistent distance from your microphone</li>
                        <li>Try to maintain a natural tone and volume</li>
                    </ul>
                </div>

                <button id="recordButton" class="btn btn-primary">Start Recording</button>
                <div id="recordingStatus" class="recording-status not-recording">
                    Not Recording
                </div>
                <div id="recordedAudio" class="audio-player" style="display: none;">
                    <h6>Recorded Sample:</h6>
                    <audio id="audioPlayer" controls></audio>
                </div>
            </div>
        </div>

        <!-- Process Voice Sample -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Step 2: Process Voice Sample</h5>
                <p class="card-text">Process the recorded voice sample to create a voice clone.</p>
                <button id="processButton" class="btn btn-success" disabled>Process Voice Sample</button>
                <div id="processingStatus" class="mt-3"></div>
            </div>
        </div>

        <!-- Test Cloned Voice -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Step 3: Test Cloned Voice</h5>
                <p class="card-text">Generate speech using your cloned voice.</p>
                <div class="mb-3">
                    <label for="testText" class="form-label">Text to Speak:</label>
                    <textarea id="testText" class="form-control" rows="3" placeholder="Enter text to convert to speech...">Hello! This is a test of your cloned voice. If you can hear this, the voice cloning was successful!</textarea>
                </div>
                <button id="generateButton" class="btn btn-primary" disabled>Generate Speech</button>
                <div id="generatedAudio" class="audio-player" style="display: none;">
                    <h6>Generated Speech:</h6>
                    <audio id="generatedPlayer" controls></audio>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let selectedProvider = 'openai';

        // Provider selection
        document.querySelectorAll('input[name="ttsProvider"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                selectedProvider = e.target.value;
            });
        });

        // Record button click handler
        document.getElementById('recordButton').addEventListener('click', async () => {
            const button = document.getElementById('recordButton');
            const status = document.getElementById('recordingStatus');
            const recordedAudio = document.getElementById('recordedAudio');
            const audioPlayer = document.getElementById('audioPlayer');

            if (button.textContent === 'Start Recording') {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        audioPlayer.src = audioUrl;
                        recordedAudio.style.display = 'block';
                        document.getElementById('processButton').disabled = false;
                    };

                    mediaRecorder.start();
                    button.textContent = 'Stop Recording';
                    status.textContent = 'Recording...';
                    status.className = 'recording-status recording';
                } catch (err) {
                    console.error('Error accessing microphone:', err);
                    alert('Error accessing microphone. Please ensure you have granted microphone permissions.');
                }
            } else {
                mediaRecorder.stop();
                button.textContent = 'Start Recording';
                status.textContent = 'Not Recording';
                status.className = 'recording-status not-recording';
            }
        });

        // Process button click handler
        document.getElementById('processButton').addEventListener('click', async () => {
            const button = document.getElementById('processButton');
            const status = document.getElementById('processingStatus');
            const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            const formData = new FormData();
            formData.append('audio', audioBlob);
            formData.append('provider', selectedProvider);

            button.disabled = true;
            status.innerHTML = '<div class="spinner-border text-primary" role="status"></div> Processing...';

            try {
                const response = await fetch('/process_voice_clone', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();

                if (data.success) {
                    status.innerHTML = '<div class="alert alert-success">Voice sample processed successfully!</div>';
                    document.getElementById('generateButton').disabled = false;
                } else {
                    status.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                }
            } catch (err) {
                console.error('Error processing voice sample:', err);
                status.innerHTML = '<div class="alert alert-danger">Error processing voice sample. Please try again.</div>';
            }

            button.disabled = false;
        });

        // Generate button click handler
        document.getElementById('generateButton').addEventListener('click', async () => {
            const button = document.getElementById('generateButton');
            const text = document.getElementById('testText').value;
            const generatedAudio = document.getElementById('generatedAudio');
            const generatedPlayer = document.getElementById('generatedPlayer');

            if (!text) {
                alert('Please enter some text to convert to speech.');
                return;
            }

            button.disabled = true;
            button.textContent = 'Generating...';

            try {
                const response = await fetch('/verify_cloned_voice', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        text: text,
                        provider: selectedProvider  // Add the selected provider
                    })
                });
                const data = await response.json();

                if (data.success) {
                    // Add timestamp to prevent caching
                    const timestamp = new Date().getTime();
                    generatedPlayer.src = `${data.audio_url}?t=${timestamp}`;
                    generatedAudio.style.display = 'block';
                    // Force reload of audio
                    generatedPlayer.load();

                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (err) {
                console.error('Error generating speech:', err);
                alert('Error generating speech. Please try again.');
            }

            button.disabled = false;
            button.textContent = 'Generate Speech';
        });
    </script>
</body>
</html> 